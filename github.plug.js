var mod=(()=>{var G=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var r in t)G(e,r,{get:t[r],enumerable:!0})},ie=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ne(t))!oe.call(e,o)&&o!==r&&G(e,o,{get:()=>t[o],enumerable:!(n=re(t,o))||n.enumerable});return e};var se=e=>ie(G({},"__esModule",{value:!0}),e);var ut={};P(ut,{functionMapping:()=>te});function U(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function ae(e,t){return syscall("sandboxFetch.fetch",e,t)}function O(){globalThis.fetch=async function(e,t){let r=await ae(e,t&&{method:t.method,headers:t.headers,body:t.body});return new Response(r.base64Body?U(r.base64Body):null,{status:r.status,headers:r.headers})}}typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var M=new Map,N=0;function k(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((r,n)=>{N++,M.set(N,{resolve:r,reject:n}),k({type:"sys",id:N,name:e,args:t})});function R(e,t){self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(o(...n.args||[]));k({type:"invr",id:n.id,result:i})}catch(i){console.error(i),k({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let o=n.id,i=M.get(o);if(!i)throw Error("Invalid request id");M.delete(o),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),k({type:"manifest",manifest:t})}O();function S(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,S(t)}}function q(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...q(n,t)];return r}async function I(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await I(n,t)];return r}async function $(e,t){if(e.children){let r=e.children.slice();for(let n of r){let o=await t(n);if(o!==void 0){let i=e.children.indexOf(n);o?e.children.splice(i,1,o):e.children.splice(i,1)}else $(n,t)}}}function x(e,t){return q(e,r=>r.type===t)[0]}function L(e,t){q(e,t)}async function j(e,t){await I(e,t)}function m(e){let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(m(r));return t.join("")}function b(e,t){let r=[];if(e.filter.length===0)r=t.slice();else e:for(let n of t){let o=n;for(let{op:i,prop:a,value:c}of e.filter)switch(i){case"=":{let p=o[a];if(Array.isArray(p)&&!Array.isArray(c)){if(!p.includes(c))continue e}else if(Array.isArray(p)&&Array.isArray(c)){if(!p.some(d=>c.includes(d)))continue e}else if(p!=c)continue e;break}case"!=":if(o[a]==c)continue e;break;case"<":if(!(o[a]<c))continue e;break;case"<=":if(!(o[a]<=c))continue e;break;case">":if(!(o[a]>c))continue e;break;case">=":if(!(o[a]>=c))continue e;break;case"=~":if(!new RegExp(c).exec(o[a]))continue e;break;case"!=~":if(new RegExp(c).exec(o[a]))continue e;break;case"in":if(!c.includes(o[a]))continue e;break}r.push(o)}return e.ordering.length>0&&(r=r.sort((n,o)=>{for(let{orderBy:i,orderDesc:a}of e.ordering){if(n[i]<o[i]||n[i]===void 0)return a?1:-1;if(n[i]>o[i]||o[i]===void 0)return a?-1:1}return 0})),e.limit&&(r=r.slice(0,e.limit)),e.select&&(r=r.map(n=>{let o={};for(let i of e.select)o[i]=n[i];return o})),r}var u={};P(u,{confirm:()=>Ne,dispatch:()=>Ee,downloadFile:()=>Pe,filterBox:()=>we,flashNotification:()=>xe,getCurrentPage:()=>ce,getCursor:()=>fe,getSelection:()=>pe,getText:()=>le,getUiOption:()=>Me,hidePanel:()=>ve,insertAtCursor:()=>ke,insertAtPos:()=>Te,moveCursor:()=>Ae,navigate:()=>ge,openUrl:()=>he,prompt:()=>Ge,reloadPage:()=>ye,replaceRange:()=>Ce,save:()=>me,setPage:()=>ue,setSelection:()=>de,setUiOption:()=>Se,showPanel:()=>be,vimEx:()=>qe});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var s=self.syscall;function ce(){return s("editor.getCurrentPage")}function ue(e){return s("editor.setPage",e)}function le(){return s("editor.getText")}function fe(){return s("editor.getCursor")}function pe(){return s("editor.getSelection")}function de(e,t){return s("editor.setSelection",e,t)}function me(){return s("editor.save")}function ge(e,t,r=!1,n=!1){return s("editor.navigate",e,t,r,n)}function ye(){return s("editor.reloadPage")}function he(e){return s("editor.openUrl",e)}function Pe(e,t){return s("editor.downloadFile",e,t)}function xe(e,t="info"){return s("editor.flashNotification",e,t)}function we(e,t,r="",n=""){return s("editor.filterBox",e,t,r,n)}function be(e,t,r,n=""){return s("editor.showPanel",e,t,r,n)}function ve(e){return s("editor.hidePanel",e)}function Te(e,t){return s("editor.insertAtPos",e,t)}function Ce(e,t,r){return s("editor.replaceRange",e,t,r)}function Ae(e,t=!1){return s("editor.moveCursor",e,t)}function ke(e){return s("editor.insertAtCursor",e)}function Ee(e){return s("editor.dispatch",e)}function Ge(e,t=""){return s("editor.prompt",e,t)}function Ne(e){return s("editor.confirm",e)}function Me(e){return s("editor.getUiOption",e)}function Se(e,t){return s("editor.setUiOption",e,t)}function qe(e){return s("editor.vimEx",e)}var g={};P(g,{parseMarkdown:()=>Fe});function Fe(e){return s("markdown.parseMarkdown",e)}var y={};P(y,{deleteAttachment:()=>_e,deletePage:()=>Ie,getAttachmentMeta:()=>Ye,getPageMeta:()=>Ue,listAttachments:()=>je,listPages:()=>De,listPlugs:()=>Le,readAttachment:()=>Be,readPage:()=>Oe,writeAttachment:()=>Qe,writePage:()=>Re});function De(e=!1){return s("space.listPages",e)}function Ue(e){return s("space.getPageMeta",e)}function Oe(e){return s("space.readPage",e)}function Re(e,t){return s("space.writePage",e,t)}function Ie(e){return s("space.deletePage",e)}function Le(){return s("space.listPlugs")}function je(){return s("space.listAttachments")}function Ye(e){return s("space.getAttachmentMeta",e)}function Be(e){return s("space.readAttachment",e)}function Qe(e,t,r){return s("space.writeAttachment",e,t,r)}function _e(e){return s("space.deleteAttachment",e)}var w={};P(w,{getEnv:()=>ze,invokeCommand:()=>We,invokeFunction:()=>Ve,listCommands:()=>He,reloadPlugs:()=>Je});function Ve(e,t,...r){return s("system.invokeFunction",e,t,...r)}function We(e){return s("system.invokeCommand",e)}function He(){return s("system.listCommands")}function Je(){s("system.reloadPlugs")}function ze(){return s("system.getEnv")}var h=self.syscall;var l={};P(l,{parse:()=>ot,stringify:()=>it});function ot(e){return h("yaml.parse",e)}function it(e){return h("yaml.stringify",e)}async function st(e,t){let r=await y.readPage(e),n=await g.parseMarkdown(r),o;return L(n,i=>{if(i.type!=="FencedCode")return!1;let a=x(i,"CodeInfo");if(t&&!a||t&&!t.includes(a.children[0].text))return!1;let c=x(i,"CodeText");return c?(o=c.children[0].text,!0):!1}),o}async function Y(e,t=["yaml"]){let r=await st(e,t);if(r!==void 0)try{return l.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function B(e){try{let t=await Y("SECRETS",["yaml","secrets"]),r=[];for(let n of e){let o=t[n];if(o)r.push(o);else throw new Error(`No such secret: ${n}`)}return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e[0]}`):t}}async function at(){try{let[e]=await B(["githubToken"]);return e}catch{console.error("No github-config page found, using default config");return}}var f=class{constructor(t){this.token=t}async apiCall(t,r={}){let n=await fetch(t,{...r,headers:{Authorization:this.token?`token ${this.token}`:void 0}});if(n.status<200||n.status>=300)throw new Error(await n.text());return n.json()}listEvents(t){return this.apiCall(`https://api.github.com/users/${t}/events?per_page=100`)}listPulls(t,r="all",n="updated"){return this.apiCall(`https://api.github.com/repos/${t}/pulls?state=${r}&sort=${n}&direction=desc&per_page=100`)}searchIssues(t,r=""){return t=encodeURIComponent(t),this.apiCall(`https://api.github.com/search/issues?q=${t}&sort=${r}&direction=desc&per_page=100`)}listNotifications(){return this.apiCall("https://api.github.com/notifications?per_page=100")}async createGist(t,r,n){return(await this.apiCall("https://api.github.com/gists",{method:"POST",body:JSON.stringify({description:t,public:r,files:n})})).id}updateGist(t,r,n,o){return this.apiCall(`https://api.github.com/gists/${t}`,{method:"PATCH",body:JSON.stringify({description:r,public:n,files:o})})}async getGist(t){return(await this.apiCall(`https://api.github.com/gists/${t}`)).files}static async fromConfig(){return new f(await at())}};async function E(e,t=[]){let r={};return S(e),await $(e,async n=>{if(n.type==="Hashtag"){if(n.parent&&n.parent.type==="Paragraph"){let d=n.children[0].text.substring(1);r.tags||(r.tags=[]),Array.isArray(r.tags)&&!r.tags.includes(d)&&r.tags.push(d)}return}if(n.type==="FrontMatter"){let d=n.children[1].children[0],T=m(d);try{let C=await l.parse(T),A={...C};if(r={...r,...C},t.length>0){let F=!1;for(let D of t)D in A&&(delete A[D],F=!0);F&&(d.text=await l.stringify(A))}if(Object.keys(A).length===0)return null}catch(C){console.error("Could not parse frontmatter",C)}}if(n.type!=="FencedCode")return;let o=x(n,"CodeInfo");if(!o||o.children[0].text!=="meta")return;let i=x(n,"CodeText");if(!i)return;let a=i.children[0].text,c=l.parse(a),p={...c};if(r={...r,...c},t.length>0){let d=!1;for(let T of t)T in p&&(delete p[T],d=!0);d&&(i.children[0].text=(await l.stringify(p)).trim())}if(Object.keys(p).length===0)return null}),r.name&&(r.displayName=r.name,delete r.name),r}async function Q(e,t){let r=null;return await j(e,async n=>{if(n.type==="FrontMatter"){let o=n.children[1].children[0],i=m(o);try{let c={...await l.parse(i),...t};r={changes:{from:o.from,to:o.to,insert:await l.stringify(c)}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),r||(r={changes:{from:0,to:0,insert:`---
`+await l.stringify(t)+`---
`}}),r}async function _({query:e}){let t=await f.fromConfig(),r=e.filter.find(i=>i.prop==="username");if(!r)throw Error("No 'username' filter specified, this is mandatory");let n=[];if(r.op==="=")n=[r.value];else if(r.op==="in")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let o=[];for(let i of await Promise.all(n.map(a=>t.listEvents(a))))o.push(...i);return e.filter.splice(e.filter.indexOf(r),1),b(e,o.map(i=>v(i)))}async function V({query:e}){let t=await f.fromConfig(),r=e.filter.find(i=>i.prop==="repo");if(!r)throw Error("No 'repo' specified, this is mandatory");e.filter.splice(e.filter.indexOf(r),1);let n=[];if(r.op==="=")n=[r.value];else if(r.op==="in")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let o=[];for(let i of await Promise.all(n.map(a=>t.listPulls(a,"all","updated"))))o.push(...i);return o=b(e,o.map(i=>v(i))),o}async function W({query:e}){let r=await(await f.fromConfig()).listNotifications();return r=b(e,r.map(n=>v(n))),r}async function H({query:e}){let t=await f.fromConfig(),r=e.filter.find(a=>a.prop==="query");if(!r)throw Error("No 'query' specified, this is mandatory");e.filter=e.filter.filter(a=>a.prop!=="query");let n="";if(r.op==="=")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let o=await t.searchIssues(n);return b(e,o.items.map(a=>v(a)))}function v(e,t=""){let r={};for(let[n,o]of Object.entries(e))t&&(n=t+"_"+n),o&&typeof o=="object"?r={...r,...v(o,n)}:r[n]=o;return r}async function J(){let e=await u.getCurrentPage(),t=await u.getText(),r=await g.parseMarkdown(t),{$share:n}=E(r,["$share"]),o=m(r);n||(n=[]);for(let c of n)if(c.startsWith("gh-gist:")){await w.invokeFunction("server","updateGist",{name:e,uri:c}),await u.flashNotification("Updated!"),await u.openUrl(`https://gist.github.com/${c.split(":")[1]}`);return}let i=await w.invokeFunction("server","createGist",e,o),a=Q(r,{$share:[...n,`gh-gist:${i}`]});await u.flashNotification("Done!"),await u.dispatch(a),await u.openUrl(`https://gist.github.com/${i}`)}async function z(e,t){return(await f.fromConfig()).createGist("",!0,{[`${e}.md`]:{content:t}})}async function K(e){return(await f.fromConfig()).getGist(e)}async function X(){let e=await u.prompt("Gist URL:");if(!e)return;let t=e.split("/"),r=t[t.length-1],n=await w.invokeFunction("server","getGist",r);if(Object.keys(n).length!==1){await u.flashNotification("Only gists with a single file are supported","error");return}let o=Object.keys(n)[0].replace(/\.md$/,""),i=Object.values(n)[0].content,a=await u.prompt("Page name:",o);a&&(await y.writePage(a,`---
$share:
- 'gh-gist:${r}'
---
${i}`),await u.navigate(a))}async function Z(){let e=await u.getText(),t=await g.parseMarkdown(e),{$share:r}=E(t);if(!r){await u.flashNotification("Not currently shared as gist","error");return}for(let n of r)if(n.startsWith("gh-gist:")){let i=`https://gist.github.com/${n.split(":")[1]}`;await u.openUrl(i);return}await u.flashNotification("Not currently shared as gist","error")}async function ee(e){let t=e.uri.split(":")[1],r=await f.fromConfig(),n=await y.readPage(e.name),o=await g.parseMarkdown(n);E(o,["$share"]);let i=m(o);return await r.updateGist(t,"",!0,{[`${e.name}.md`]:{content:i}}),!0}var te={queryEvents:_,queryPulls:V,queryNotifications:W,querySearchIssues:H,shareGistCommand:J,loadGistCommand:X,openGistCommand:Z,createGist:z,updateGist:ee,getGist:K},ct={name:"github",requiredPermissions:["fetch"],functions:{queryEvents:{path:"./github.ts:queryEvents",events:["query:gh-event"]},queryPulls:{path:"./github.ts:queryPulls",events:["query:gh-pull"]},queryNotifications:{path:"./github.ts:queryNotifications",events:["query:gh-notification"]},querySearchIssues:{path:"./github.ts:querySearchIssues",events:["query:gh-search-issue"]},shareGistCommand:{path:"./github.ts:shareGistCommand",command:{name:"Share: Gist: Public Gist"}},loadGistCommand:{path:"./github.ts:loadGistCommand",command:{name:"Share: Gist: Load"}},openGistCommand:{path:"./github.ts:openGistCommand",command:{name:"Share: Gist: Open In Browser"}},createGist:{path:"./github.ts:createGist",env:"server"},updateGist:{path:"./github.ts:updateGist",env:"server",events:["share:gh-gist"]},getGist:{path:"./github.ts:getGist",env:"server"}},assets:{}};R(te,ct);return se(ut);})();
