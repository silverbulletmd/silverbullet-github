var mod=(()=>{var A=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var w=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},se=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ie(e))!oe.call(t,i)&&i!==r&&A(t,i,{get:()=>e[i],enumerable:!(n=ne(e,i))||n.enumerable});return t};var ae=t=>se(A({},"__esModule",{value:!0}),t);var Ze={};w(Ze,{functionMapping:()=>re});function R(t){let e=atob(t),r=e.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=e.charCodeAt(i);return n}function ce(t,e){return syscall("sandboxFetch.fetch",t,e)}function I(){globalThis.fetch=async function(t,e){let r=await ce(t,e&&{method:e.method,headers:e.headers,body:e.body});return new Response(r.base64Body?R(r.base64Body):null,{status:r.status,headers:r.headers})}}typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var N=new Map,E=0;function M(t){self.postMessage(t)}self.syscall=async(t,...e)=>await new Promise((r,n)=>{E++,N.set(E,{resolve:r,reject:n}),M({type:"sys",id:E,name:t,args:e})});function U(t,e){self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let i=t[n.name];if(!i)throw new Error(`Function not loaded: ${n.name}`);try{let o=await Promise.resolve(i(...n.args||[]));M({type:"invr",id:n.id,result:o})}catch(o){console.error(o),M({type:"invr",id:n.id,error:o.message})}}break;case"sysr":{let i=n.id,o=N.get(i);if(!o)throw Error("Invalid request id");N.delete(i),n.error?o.reject(new Error(n.error)):o.resolve(n.result)}break}})().catch(console.error)}),M({type:"manifest",manifest:e})}I();function G(t){if(t.children)for(let e of t.children){if(e.parent)return;e.parent=t,G(e)}}function $(t,e){if(e(t))return[t];let r=[];if(t.children)for(let n of t.children)r=[...r,...$(n,e)];return r}async function j(t,e){if(await e(t))return[t];let r=[];if(t.children)for(let n of t.children)r=[...r,...await j(n,e)];return r}async function S(t,e){if(t.children){let r=t.children.slice();for(let n of r){let i=await e(n);if(i!==void 0){let o=t.children.indexOf(n);i?t.children.splice(o,1,i):t.children.splice(o,1)}else S(n,e)}}}function h(t,e){return $(t,r=>r.type===e)[0]}function L(t,e){$(t,e)}async function Y(t,e){await j(t,e)}function g(t){let e=[];if(t.text!==void 0)return t.text;for(let r of t.children)e.push(g(r));return e.join("")}function v(t,e){let r=[];if(t.filter.length===0)r=e.slice();else e:for(let n of e){let i=n;for(let{op:o,prop:a,value:c}of t.filter)switch(o){case"=":{let p=i[a];if(Array.isArray(p)&&!Array.isArray(c)){if(!p.includes(c))continue e}else if(Array.isArray(p)&&Array.isArray(c)){if(!p.some(d=>c.includes(d)))continue e}else if(p!=c)continue e;break}case"!=":if(i[a]==c)continue e;break;case"<":if(!(i[a]<c))continue e;break;case"<=":if(!(i[a]<=c))continue e;break;case">":if(!(i[a]>c))continue e;break;case">=":if(!(i[a]>=c))continue e;break;case"=~":if(!new RegExp(c).exec(i[a]))continue e;break;case"!=~":if(new RegExp(c).exec(i[a]))continue e;break;case"in":if(!c.includes(i[a]))continue e;break}r.push(i)}return t.ordering.length>0&&(r=r.sort((n,i)=>{for(let{orderBy:o,orderDesc:a}of t.ordering){if(n[o]<i[o]||n[o]===void 0)return a?1:-1;if(n[o]>i[o]||i[o]===void 0)return a?-1:1}return 0})),t.limit&&(r=r.slice(0,t.limit)),t.select&&(r=r.map(n=>{let i={};for(let o of t.select)i[o]=n[o];return i})),r}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var s=self.syscall;var l={};w(l,{confirm:()=>Ge,dispatch:()=>Ee,downloadFile:()=>we,filterBox:()=>be,flashNotification:()=>ve,getCurrentPage:()=>ue,getCursor:()=>de,getSelection:()=>me,getText:()=>pe,getUiOption:()=>$e,hidePanel:()=>Fe,insertAtCursor:()=>Ae,insertAtPos:()=>Ce,moveCursor:()=>ke,navigate:()=>he,openUrl:()=>xe,prompt:()=>Ne,reloadPage:()=>Pe,replaceRange:()=>Me,save:()=>ye,setPage:()=>fe,setSelection:()=>ge,setUiOption:()=>Se,showPanel:()=>Te,vimEx:()=>qe});function ue(){return s("editor.getCurrentPage")}function fe(t){return s("editor.setPage",t)}function pe(){return s("editor.getText")}function de(){return s("editor.getCursor")}function me(){return s("editor.getSelection")}function ge(t,e){return s("editor.setSelection",t,e)}function ye(){return s("editor.save")}function he(t,e,r=!1,n=!1){return s("editor.navigate",t,e,r,n)}function Pe(){return s("editor.reloadPage")}function xe(t){return s("editor.openUrl",t)}function we(t,e){return s("editor.downloadFile",t,e)}function ve(t,e="info"){return s("editor.flashNotification",t,e)}function be(t,e,r="",n=""){return s("editor.filterBox",t,e,r,n)}function Te(t,e,r,n=""){return s("editor.showPanel",t,e,r,n)}function Fe(t){return s("editor.hidePanel",t)}function Ce(t,e){return s("editor.insertAtPos",t,e)}function Me(t,e,r){return s("editor.replaceRange",t,e,r)}function ke(t,e=!1){return s("editor.moveCursor",t,e)}function Ae(t){return s("editor.insertAtCursor",t)}function Ee(t){return s("editor.dispatch",t)}function Ne(t,e=""){return s("editor.prompt",t,e)}function Ge(t){return s("editor.confirm",t)}function $e(t){return s("editor.getUiOption",t)}function Se(t,e){return s("editor.setUiOption",t,e)}function qe(t){return s("editor.vimEx",t)}var y={};w(y,{parseMarkdown:()=>Oe});function Oe(t){return s("markdown.parseMarkdown",t)}var q=class{listPages(e=!1){return s("space.listPages",e)}getPageMeta(e){return s("space.getPageMeta",e)}readPage(e){return s("space.readPage",e)}writePage(e,r){return s("space.writePage",e,r)}deletePage(e){return s("space.deletePage",e)}listPlugs(){return s("space.listPlugs")}listAttachments(){return s("space.listAttachments")}getAttachmentMeta(e){return s("space.getAttachmentMeta",e)}readAttachment(e){return s("space.readAttachment",e)}writeAttachment(e,r,n){return s("space.writeAttachment",e,r,n)}deleteAttachment(e){return s("space.deleteAttachment",e)}readFile(e,r){return s("space.readFile",e,r)}getFileMeta(e){return s("space.getFileMeta",e)}writeFile(e,r,n){return s("space.writeFile",e,r,n)}deleteFile(e){return s("space.deleteFile",e)}listFiles(e){return s("space.listFiles",e)}},P=new q;var x={};w(x,{getEnv:()=>Le,invokeCommand:()=>Ie,invokeFunction:()=>Re,listCommands:()=>Ue,reloadPlugs:()=>je});function Re(t,e,...r){return s("system.invokeFunction",t,e,...r)}function Ie(t){return s("system.invokeCommand",t)}function Ue(){return s("system.listCommands")}function je(){s("system.reloadPlugs")}function Le(){return s("system.getEnv")}var m=self.syscall;var u={};w(u,{parse:()=>He,stringify:()=>Je});function He(t){return m("yaml.parse",t)}function Je(t){return m("yaml.stringify",t)}async function ze(t,e){let r=await P.readPage(t),n=await y.parseMarkdown(r),i;return L(n,o=>{if(o.type!=="FencedCode")return!1;let a=h(o,"CodeInfo");if(e&&!a||e&&!e.includes(a.children[0].text))return!1;let c=h(o,"CodeText");return c?(i=c.children[0].text,!0):!1}),i}async function B(t,e=["yaml"]){let r=await ze(t,e);if(r!==void 0)try{return u.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function Q(t){try{let e=await B("SECRETS",["yaml","secrets"]),r=[];for(let n of t){let i=e[n];if(i)r.push(i);else throw new Error(`No such secret: ${n}`)}return r}catch(e){throw e.message==="Not found"?new Error(`No such secret: ${t[0]}`):e}}async function Ke(){try{let[t]=await Q(["githubToken"]);return t}catch{console.error("No github-config page found, using default config");return}}var f=class{constructor(e){this.token=e}async apiCall(e,r={}){let n=await fetch(e,{...r,headers:{Authorization:this.token?`token ${this.token}`:void 0}});if(n.status<200||n.status>=300)throw new Error(await n.text());return n.json()}listEvents(e){return this.apiCall(`https://api.github.com/users/${e}/events?per_page=100`)}listPulls(e,r="all",n="updated"){return this.apiCall(`https://api.github.com/repos/${e}/pulls?state=${r}&sort=${n}&direction=desc&per_page=100`)}searchIssues(e,r=""){return e=encodeURIComponent(e),this.apiCall(`https://api.github.com/search/issues?q=${e}&sort=${r}&direction=desc&per_page=100`)}listNotifications(){return this.apiCall("https://api.github.com/notifications?per_page=100")}async createGist(e,r,n){return(await this.apiCall("https://api.github.com/gists",{method:"POST",body:JSON.stringify({description:e,public:r,files:n})})).id}updateGist(e,r,n,i){return this.apiCall(`https://api.github.com/gists/${e}`,{method:"PATCH",body:JSON.stringify({description:r,public:n,files:i})})}async getGist(e){return(await this.apiCall(`https://api.github.com/gists/${e}`)).files}static async fromConfig(){return new f(await Ke())}};async function k(t,e=[]){let r={};return G(t),await S(t,async n=>{if(n.type==="Hashtag"){if(n.parent&&n.parent.type==="Paragraph"){let d=n.children[0].text.substring(1);r.tags||(r.tags=[]),Array.isArray(r.tags)&&!r.tags.includes(d)&&r.tags.push(d)}return}if(n.type==="FrontMatter"){let d=n.children[1].children[0],T=g(d);try{let F=await u.parse(T),C={...F};if(r={...r,...F},e.length>0){let D=!1;for(let O of e)O in C&&(delete C[O],D=!0);D&&(d.text=await u.stringify(C))}if(Object.keys(C).length===0)return null}catch(F){console.error("Could not parse frontmatter",F)}}if(n.type!=="FencedCode")return;let i=h(n,"CodeInfo");if(!i||i.children[0].text!=="meta")return;let o=h(n,"CodeText");if(!o)return;let a=o.children[0].text,c=u.parse(a),p={...c};if(r={...r,...c},e.length>0){let d=!1;for(let T of e)T in p&&(delete p[T],d=!0);d&&(o.children[0].text=(await u.stringify(p)).trim())}if(Object.keys(p).length===0)return null}),r.name&&(r.displayName=r.name,delete r.name),r}async function _(t,e){let r=null;return await Y(t,async n=>{if(n.type==="FrontMatter"){let i=n.children[1].children[0],o=g(i);try{let c={...await u.parse(o),...e};r={changes:{from:i.from,to:i.to,insert:await u.stringify(c)}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),r||(r={changes:{from:0,to:0,insert:`---
`+await u.stringify(e)+`---
`}}),r}async function V({query:t}){let e=await f.fromConfig(),r=t.filter.find(o=>o.prop==="username");if(!r)throw Error("No 'username' filter specified, this is mandatory");let n=[];if(r.op==="=")n=[r.value];else if(r.op==="in")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let i=[];for(let o of await Promise.all(n.map(a=>e.listEvents(a))))i.push(...o);return t.filter.splice(t.filter.indexOf(r),1),v(t,i.map(o=>b(o)))}async function W({query:t}){let e=await f.fromConfig(),r=t.filter.find(o=>o.prop==="repo");if(!r)throw Error("No 'repo' specified, this is mandatory");t.filter.splice(t.filter.indexOf(r),1);let n=[];if(r.op==="=")n=[r.value];else if(r.op==="in")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let i=[];for(let o of await Promise.all(n.map(a=>e.listPulls(a,"all","updated"))))i.push(...o);return i=v(t,i.map(o=>b(o))),i}async function H({query:t}){let r=await(await f.fromConfig()).listNotifications();return r=v(t,r.map(n=>b(n))),r}async function J({query:t}){let e=await f.fromConfig(),r=t.filter.find(a=>a.prop==="query");if(!r)throw Error("No 'query' specified, this is mandatory");t.filter=t.filter.filter(a=>a.prop!=="query");let n="";if(r.op==="=")n=r.value;else throw new Error(`Unsupported operator ${r.op}`);let i=await e.searchIssues(n);return v(t,i.items.map(a=>b(a)))}function b(t,e=""){let r={};for(let[n,i]of Object.entries(t))e&&(n=e+"_"+n),i&&typeof i=="object"?r={...r,...b(i,n)}:r[n]=i;return r}async function z(){let t=await l.getCurrentPage(),e=await l.getText(),r=await y.parseMarkdown(e),{$share:n}=k(r,["$share"]),i=g(r);n||(n=[]);for(let c of n)if(c.startsWith("gh-gist:")){await x.invokeFunction("server","updateGist",{name:t,uri:c}),await l.flashNotification("Updated!"),await l.openUrl(`https://gist.github.com/${c.split(":")[1]}`);return}let o=await x.invokeFunction("server","createGist",t,i),a=_(r,{$share:[...n,`gh-gist:${o}`]});await l.flashNotification("Done!"),await l.dispatch(a),await l.openUrl(`https://gist.github.com/${o}`)}async function K(t,e){return(await f.fromConfig()).createGist("",!0,{[`${t}.md`]:{content:e}})}async function X(t){return(await f.fromConfig()).getGist(t)}async function Z(){let t=await l.prompt("Gist URL:");if(!t)return;let e=t.split("/"),r=e[e.length-1],n=await x.invokeFunction("server","getGist",r);if(Object.keys(n).length!==1){await l.flashNotification("Only gists with a single file are supported","error");return}let i=Object.keys(n)[0].replace(/\.md$/,""),o=Object.values(n)[0].content,a=await l.prompt("Page name:",i);a&&(await P.writePage(a,`---
$share:
- 'gh-gist:${r}'
---
${o}`),await l.navigate(a))}async function ee(){let t=await l.getText(),e=await y.parseMarkdown(t),{$share:r}=k(e);if(!r){await l.flashNotification("Not currently shared as gist","error");return}for(let n of r)if(n.startsWith("gh-gist:")){let o=`https://gist.github.com/${n.split(":")[1]}`;await l.openUrl(o);return}await l.flashNotification("Not currently shared as gist","error")}async function te(t){let e=t.uri.split(":")[1],r=await f.fromConfig(),n=await P.readPage(t.name),i=await y.parseMarkdown(n);k(i,["$share"]);let o=g(i);return await r.updateGist(e,"",!0,{[`${t.name}.md`]:{content:o}}),!0}var re={queryEvents:V,queryPulls:W,queryNotifications:H,querySearchIssues:J,shareGistCommand:z,loadGistCommand:Z,openGistCommand:ee,createGist:K,updateGist:te,getGist:X},Xe={name:"github",imports:["https://get.silverbullet.md/global.plug.json"],functions:{queryEvents:{path:"./github.ts:queryEvents",events:["query:gh-event"]},queryPulls:{path:"./github.ts:queryPulls",events:["query:gh-pull"]},queryNotifications:{path:"./github.ts:queryNotifications",events:["query:gh-notification"]},querySearchIssues:{path:"./github.ts:querySearchIssues",events:["query:gh-search-issue"]},shareGistCommand:{path:"./github.ts:shareGistCommand",command:{name:"Share: Gist: Public Gist"}},loadGistCommand:{path:"./github.ts:loadGistCommand",command:{name:"Share: Gist: Load"}},openGistCommand:{path:"./github.ts:openGistCommand",command:{name:"Share: Gist: Open In Browser"}},createGist:{path:"./github.ts:createGist",env:"server"},updateGist:{path:"./github.ts:updateGist",env:"server",events:["share:gh-gist"]},getGist:{path:"./github.ts:getGist",env:"server"}},assets:{}};U(re,Xe);return ae(Ze);})();
